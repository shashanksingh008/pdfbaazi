<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImagesFromPDFs | Premium Document Extraction</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --text: #000000;
            --accent: #000000;
            --border: #000000;
            --gray: #f5f5f5;
            --muted: #737373;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Progress Bar */
        #progressContainer {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: #eee;
            z-index: 2000;
            display: none;
        }

        #progressBar {
            height: 100%;
            background: black;
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Navbar */
        .navbar {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .navbar {
                padding: 1rem;
                justify-content: center;
                flex-direction: column;
                gap: 0.75rem;
            }

            .nav-actions {
                width: 100%;
                justify-content: space-between;
                gap: 0.5rem;
            }

            #searchContainer {
                flex: 1;
            }

            #pageSearch {
                width: 100% !important;
            }

            #zipContainer {
                flex-shrink: 0;
            }
        }

        .logo {
            font-weight: 800;
            font-size: 1.5rem;
            letter-spacing: -0.05em;
            text-decoration: none;
            color: black;
            display: flex;
            align-items: center;
        }

        .logo span {
            background: black;
            color: white;
            padding: 0.2rem 0.5rem;
            margin-right: 0.1rem;
            font-weight: 900;
        }

        /* Main Hero Section */
        .hero {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: -0.03em;
            margin-bottom: 1rem;
            text-align: center;
        }

        .hero-subtitle {
            color: var(--muted);
            margin-bottom: 3rem;
            text-align: center;
            font-size: 1rem;
        }

        /* Big Upload Component */
        .upload-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
        }

        .upload-container {
            width: 100%;
            border: 1px solid var(--border);
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .upload-container:hover {
            background: var(--gray);
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 3rem;
            font-weight: 200;
        }

        .btn-black {
            background: var(--accent);
            color: white;
            border: 1px solid var(--border);
            padding: 1rem 2.5rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.15em;
            transition: all 0.2s;
        }

        .btn-black:hover {
            background: white;
            color: black;
        }

        /* Results View */
        #resultsView {
            display: none;
            padding: 3rem 2rem;
            width: 100%;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .item-card {
            border: 1px solid var(--border);
            background: white;
            transition: opacity 0.3s, border-color 0.3s;
        }

        .item-image-wrapper {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: center;
            background: #fafafa;
        }

        .item-image-wrapper img {
            max-width: 100%;
            height: auto;
        }

        /* Footer */
        footer {
            padding: 3rem 2rem;
            border-top: 1px solid #eee;
            text-align: center;
            margin-top: auto;
        }

        .footer-icons {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
            filter: grayscale(1);
        }

        .security-tag {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .copyright {
            font-size: 0.7rem;
            color: var(--muted);
            letter-spacing: 0.05em;
        }

        /* Overlay - Centered over upload component */
        #overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .loader-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .loader {
            width: 24px; height: 24px;
            border: 1px solid #eee;
            border-top: 1px solid black;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            .hero-title { font-size: 1.8rem; }
            .upload-container { padding: 3rem 1rem; }
            /* .navbar { padding: 1rem; } */ /* Removed as it's handled above */

            /* Results View Mobile Fixes */
            .results-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            #resultsView {
                padding: 2rem 1rem;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 0.5rem;
            }

            .item-card-content {
                padding: 1rem !important;
                flex-direction: column;
                align-items: flex-start !important;
                gap: 1rem;
            }

            .item-card-actions {
                width: 100%;
            }

            .item-card-actions .btn-black {
                flex: 1;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="progressContainer">
        <div id="progressBar"></div>
    </div>

    <nav class="navbar">
        <a href="/" class="logo">
            <span>images</span>frompdfs.com
        </a>
        <div class="nav-actions">
            <div id="searchContainer" style="display: none; position: relative;">
                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.4;">üîç</span>
                <input type="text" id="pageSearch" placeholder="Search page..." 
                    style="padding: 0.6rem 1rem 0.6rem 2.5rem; border: 1px solid black; font-size: 0.75rem; width: 160px; outline: none;">
            </div>
            <div id="zipContainer" style="display: none;">
                <button class="btn-black" id="downloadZipBtn" style="padding: 0.6rem 1rem; font-size: 0.7rem; white-space: nowrap;">Zip</button>
            </div>
        </div>
    </nav>

    <!-- Initial Upload View -->
    <div id="uploadView" class="hero">
        <h1 class="hero-title">Extract images and tables from any PDF or Image.</h1>
        <p class="hero-subtitle">High-resolution extraction powered by AI. No registration required.</p>
        <div class="upload-wrapper">
            <div class="upload-container" id="dropZone">
                <input type="file" id="fileInput" multiple accept="application/pdf,image/png,image/jpeg,image/webp" style="display: none;">
                <div class="upload-icon">‚Üë</div>
                <div style="font-weight: 600; font-size: 0.9rem;">Drop your PDF or Images here</div>
                <p style="font-size: 0.8rem; color: var(--muted);">Supports PDF, PNG, JPG, WEBP</p>
                <button class="btn-black" style="margin-top: 1rem;">Select Files</button>
            </div>

            <div id="overlay">
                <div class="loader-row">
                    <div class="loader"></div>
                    <p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.2em; font-weight: 700; margin: 0;">Processing <span id="percentText">0%</span></p>
                </div>
                <div id="loadingMessage" style="font-size: 0.85rem; font-style: italic; color: #555; line-height: 1.4; margin-top: 1rem; max-width: 400px;">
                    "The best way to predict the future is to invent it."
                </div>
            </div>
        </div>

        <p style="font-size: 0.8rem; color: var(--muted); margin-top: 2rem; text-align: center; font-style: italic;">
            * Free usage limit: 5 extractions per user. Max file size: 10MB. <br>
            Need more? Contact <a href="mailto:abhishek@activat.io" style="color: black; font-weight: 600;">abhishek@activat.io</a>
        </p>
    </div>

    <!-- Results View -->
    <div id="resultsView">
        <div class="results-header" style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid black; padding-bottom: 1rem;">
            <h2 style="font-weight: 300;">Extracted Assets</h2>
            <div id="countText" style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em;"></div>
        </div>
        <div class="results-grid" id="resultsGrid"></div>
    </div>

    <footer>
        <div class="footer-icons">
            <div class="security-tag">üîí SSL Encrypted</div>
            <div class="security-tag">üõ°Ô∏è Private & Secure</div>
            <div class="security-tag">‚ö° AI Powered</div>
        </div>
        <p class="copyright">&copy; 2025 ACTIVAT.IO. ALL RIGHTS RESERVED.</p>
        <p style="font-size: 0.7rem; color: var(--muted); margin-top: 0.5rem;">
            Contact: <a href="mailto:abhishek@activat.io" style="color: var(--muted); text-decoration: underline;">abhishek@activat.io</a>
        </p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const uploadView = document.getElementById('uploadView');
        const resultsView = document.getElementById('resultsView');
        const resultsGrid = document.getElementById('resultsGrid');
        const overlay = document.getElementById('overlay');
        const zipContainer = document.getElementById('zipContainer');
        const downloadZipBtn = document.getElementById('downloadZipBtn');
        const countText = document.getElementById('countText');
        const loadingMessage = document.getElementById('loadingMessage');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const percentText = document.getElementById('percentText');
        const searchContainer = document.getElementById('searchContainer');
        const pageSearch = document.getElementById('pageSearch');

        const API_BASE = 'https://api.aws.us-east-1.cerebrium.ai/v4/p-ba56f76c/imagesfrompdfs-backend';
        const AUTH_TOKEN = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJwcm9qZWN0SWQiOiJwLWJhNTZmNzZjIiwiaWF0IjoxNzY2NzUwMDIwLCJleHAiOjIwODIzMjYwMjB9.fRuvqqzPpGzBf6hhOn5jcER-8RIONb-W89ouvSPeir0VH_e8mRcOr917RtmiVXgtdSeDG-hH1nO-s9M9Jg0qmkmaO7ML96ipKws5mC8B3vp0qqiUjq3a-D-_IYBMitNZ2qmOooYR1lxOA3sNLafHAZ4uHIgZWVj6SN10sHTm--Z0xXMryR6QyQYNwJU_hbErwdnZY41JBJmCpEmYCUvKq-pfS0X1Gp2rCrXHtttZ3qLIDNvTpfJhSozCi_sZ4TNo8hoYdhRcsd5jgQ-IWek9_QTUNI7fed2mJUtbu5zL4iQpC3BEY5csfkj0G_CPpTOd-3T-k_ciHlOCJghgUt-1bg';
        let currentSessionId = null;
        let allExtractionsGlobal = []; // Store all extractions for ZIP generation

        // Helper to convert file to base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        const messages = [
            "Did you know? The first PDF was created in 1993.",
            "Why did the PDF go to the doctor? It had too many 'attachments'.",
            "Processing your document with high-precision AI...",
            "Almost there! We're cropping the perfect figures for you.",
            "Fun fact: 'PDF' stands for Portable Document Format.",
            "Why don't scientists trust atoms? Because they make up everything!",
            "Success is not final, failure is not fatal: it is the courage to continue that counts.",
            "Your files are being handled securely and privately.",
            "I told my computer I needed a break, and now it won't stop sending me KitKat ads.",
            "The only limit to our realization of tomorrow will be our doubts of today."
        ];

        function updateLoadingMessage() {
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            loadingMessage.innerText = randomMessage;
        }

        dropZone.onclick = () => fileInput.click();

        fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
                processFiles();
            }
        };

        async function processFiles() {
            const files = Array.from(fileInput.files);
            
            // 1. Check File Size Limit (10MB)
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB in bytes
            for (const file of files) {
                if (file.size > MAX_FILE_SIZE) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return;
                }
            }

            // 2. Check Usage Limit (5 times per session/IP via LocalStorage)
            // Note: True IP limiting requires a backend, but LocalStorage is a good frontend deterrent.
            const usageCount = parseInt(localStorage.getItem('pdf_usage_count') || '0');
            if (usageCount >= 5) {
                alert("You have reached the limit of 5 extractions. Please contact support for more access.");
                return;
            }

            overlay.style.display = 'flex';
            progressContainer.style.display = 'block';
            updateLoadingMessage();
            
            const messageInterval = setInterval(updateLoadingMessage, 4000);
            
            let allExtractions = [];
            const totalFiles = files.length;

            try {
                for (let i = 0; i < totalFiles; i++) {
                    const file = files[i];
                    
                    // Use FormData for efficient binary transfer
                    const formData = new FormData();
                    formData.append('files', file); 
                    
                    // Start a "magic" sub-progress for each file
                    let subPercent = 0;
                    const subInterval = setInterval(() => {
                        if (subPercent < 90) {
                            subPercent += Math.random() * 15;
                            const totalPercent = Math.min(
                                Math.round(((i + (subPercent/100)) / totalFiles) * 100),
                                Math.round(((i + 0.99) / totalFiles) * 100)
                            );
                            progressBar.style.width = `${totalPercent}%`;
                            percentText.innerText = `${totalPercent}%`;
                        }
                    }, 400);

                    const res = await fetch(`${API_BASE}/process`, { 
                        method: 'POST', 
                        headers: {
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: formData
                    });
                    
                    if (!res.ok) {
                        const errorText = await res.text();
                        console.error("Upload failed:", errorText);
                        alert("Error processing file: " + file.name);
                        clearInterval(subInterval);
                        continue;
                    }

                    const data = await res.json();
                    
                    clearInterval(subInterval);
                    allExtractions = [...allExtractions, ...data.extractions];
                    allExtractionsGlobal = [...allExtractionsGlobal, ...data.extractions]; // Update global list
                    currentSessionId = data.session_id;

                    const finalPercent = Math.round(((i + 1) / totalFiles) * 100);
                    progressBar.style.width = `${finalPercent}%`;
                    percentText.innerText = `${finalPercent}%`;
                }

                // Increment usage count after successful processing
                localStorage.setItem('pdf_usage_count', (usageCount + 1).toString());

                renderResults(allExtractions);
                progressBar.style.width = '100%';
                percentText.innerText = '100%';
                
                setTimeout(() => {
                    uploadView.style.display = 'none';
                    resultsView.style.display = 'block';
                    zipContainer.style.display = 'block';
                    searchContainer.style.display = 'block';
                }, 500);
            } catch (err) {
                alert('Error processing files.');
            } finally {
                clearInterval(messageInterval);
                overlay.style.display = 'none';
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 1000);
            }
        }

        function renderResults(assets) {
            countText.innerText = `${assets.length} Assets Extracted`;
            resultsGrid.innerHTML = assets.map((asset, index) => `
                <div class="item-card" data-page="${asset.source.toLowerCase()}" id="asset-${index}">
                    <div class="item-image-wrapper">
                        <img src="${asset.data}" alt="${asset.label}">
                    </div>
                    <div class="item-card-content" style="padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700;">${asset.label}</div>
                            <div style="font-size: 0.7rem; color: #737373;">${asset.source}</div>
                        </div>
                        <div class="item-card-actions" style="display: flex; gap: 0.5rem;">
                            <button class="btn-black" style="padding: 0.5rem 1rem; font-size: 0.6rem;" onclick="viewImage('${asset.data}')">View</button>
                            <button class="btn-black" style="padding: 0.5rem 0.8rem; font-size: 0.8rem;" onclick="downloadBase64Image('${asset.data}', '${asset.label}_${asset.id}.png')" title="Download">‚Üì</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function viewImage(base64Data) {
            const win = window.open();
            win.document.write(`<img src="${base64Data}" style="max-width:100%">`);
        }

        function downloadBase64Image(base64Data, filename) {
            const a = document.createElement('a');
            a.href = base64Data;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function downloadImage(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(blobUrl);
                document.body.removeChild(a);
            } catch (err) {
                console.error('Download failed', err);
                window.open(url, '_blank');
            }
        }

        pageSearch.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.item-card');
            let firstMatch = null;

            cards.forEach(card => {
                const pageInfo = card.dataset.page;
                if (pageInfo.includes(query) && query !== "") {
                    card.style.borderColor = "black";
                    card.style.opacity = "1";
                    if (!firstMatch) firstMatch = card;
                } else if (query === "") {
                    card.style.borderColor = "black";
                    card.style.opacity = "1";
                } else {
                    card.style.opacity = "0.3";
                    card.style.borderColor = "#eee";
                }
            });

            if (firstMatch) {
                firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

        downloadZipBtn.onclick = async () => {
            if (allExtractionsGlobal.length === 0) {
                alert("No assets to download.");
                return;
            }
            
            const zip = new JSZip();
            const folder = zip.folder("extractions");
            
            // Add each base64 image to the zip
            allExtractionsGlobal.forEach((asset, index) => {
                const base64Data = asset.data.split(',')[1];
                const filename = `${asset.label}_${asset.id}_${index}.png`;
                folder.file(filename, base64Data, {base64: true});
            });
            
            const content = await zip.generateAsync({type: "blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "all_extractions.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = '#f5f5f5'; });
        dropZone.addEventListener('dragleave', () => { dropZone.style.background = 'white'; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.background = 'white';
            fileInput.files = e.dataTransfer.files;
            processFiles();
        });
    </script>
</body>
</html>
